name: Rewrite Remote Repo

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository path (e.g., owner/repo)'
        required: true
      branch:
        description: 'Target branch to rewrite'
        default: 'master'
        required: true
      max_commits:
        description: 'Number of recent commits to rewrite'
        default: '10'
        required: true
      provider:
        description: 'AI Provider'
        default: 'deepseek'
        type: choice
        options:
          - deepseek
          - openai
      language:
        description: 'Commit message language'
        default: 'zh'
        required: true
      force_rewrite:
        description: 'Rewrite even well-formed commits'
        type: boolean
        default: true

jobs:
  rewrite-remote:
    name: Rewrite Remote Repository
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Execute Rewrite
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Clean input repo string (remove https://github.com/ if present)
          CLEAN_REPO=$(echo "${{ inputs.target_repo }}" | sed 's|https://github.com/||' | sed 's|.git$||')
          
          # Construct secure URL with PAT
          # Ensure you have EXTERNAL_REPO_TOKEN set in your Repository Secrets
          REPO_URL="https://${{ secrets.EXTERNAL_REPO_TOKEN }}@github.com/${CLEAN_REPO}.git"
          
          # Prepare arguments
          ARGS="--repo $REPO_URL --branch ${{ inputs.branch }} --max-commits ${{ inputs.max_commits }} --language ${{ inputs.language }} --push --skip-remote-consent --quiet"
          
          if [ "${{ inputs.force_rewrite }}" == "true" ]; then
            ARGS="$ARGS --no-skip-well-formed"
          fi
          
          echo "ðŸš€ Starting rewrite for ${CLEAN_REPO}..."
          
          # Run via uv
          uv run git-rewrite-commits --provider ${{ inputs.provider }} $ARGS
          
          echo "âœ… Done!"
