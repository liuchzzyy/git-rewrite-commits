name: Rewrite Remote Repo

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (e.g., owner/repo or https://github.com/owner/repo)'
        required: true
      branch:
        description: 'Target branch to rewrite'
        default: 'master'
        required: true
      max_commits:
        description: 'Number of recent commits to rewrite'
        default: '10'
        required: true
      provider:
        description: 'AI Provider'
        default: 'deepseek'
        type: choice
        options:
          - deepseek
          - openai
      model:
        description: 'AI Model (optional, uses provider default if empty)'
        required: false
      language:
        description: 'Commit message language'
        default: 'zh'
        required: true
      force_rewrite:
        description: 'Rewrite even well-formed commits'
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  rewrite-remote:
    name: Rewrite Remote Repository
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate inputs
        run: |
          if [ -z "${{ secrets.EXTERNAL_REPO_TOKEN }}" ]; then
            echo "âŒ Error: EXTERNAL_REPO_TOKEN secret is not set!"
            echo "Please add a Personal Access Token with repo permissions to your repository secrets."
            exit 1
          fi
          
          if [ -z "${{ inputs.target_repo }}" ]; then
            echo "âŒ Error: target_repo is required!"
            exit 1
          fi
          
          echo "âœ… Input validation passed"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Configure Git Identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Execute Rewrite
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Clean input repo string (remove https://github.com/ and .git if present)
          CLEAN_REPO=$(echo "${{ inputs.target_repo }}" | sed 's|https://github.com/||' | sed 's|.git$||' | sed 's|/$||')
          
          echo "ğŸ“¦ Target repository: ${CLEAN_REPO}"
          echo "ğŸŒ¿ Branch: ${{ inputs.branch }}"
          echo "ğŸ“ Max commits: ${{ inputs.max_commits }}"
          echo "ğŸ¤– Provider: ${{ inputs.provider }}"
          echo "ğŸŒ Language: ${{ inputs.language }}"
          echo "ğŸ”„ Force rewrite: ${{ inputs.force_rewrite }}"
          
          # Construct secure URL with PAT
          REPO_URL="https://${{ secrets.EXTERNAL_REPO_TOKEN }}@github.com/${CLEAN_REPO}.git"
          
          # Prepare base arguments
          ARGS="--repo $REPO_URL"
          ARGS="$ARGS --branch ${{ inputs.branch }}"
          ARGS="$ARGS --max-commits ${{ inputs.max_commits }}"
          ARGS="$ARGS --language ${{ inputs.language }}"
          ARGS="$ARGS --push"
          ARGS="$ARGS --skip-remote-consent"
          ARGS="$ARGS --skip-backup"
          ARGS="$ARGS --quiet"
          
          # Add model if specified
          if [ -n "${{ inputs.model }}" ]; then
            ARGS="$ARGS --model ${{ inputs.model }}"
            echo "ğŸ§  Model: ${{ inputs.model }}"
          fi
          
          # Add force rewrite flag
          if [ "${{ inputs.force_rewrite }}" == "true" ]; then
            ARGS="$ARGS --no-skip-well-formed"
          fi
          
          echo ""
          echo "ğŸš€ Starting rewrite for ${CLEAN_REPO}..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Run via uv
          uv run git-rewrite-commits --provider ${{ inputs.provider }} $ARGS
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Rewrite completed successfully!"
