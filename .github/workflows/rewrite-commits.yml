name: AI Commit Rewriter

on:
  workflow_dispatch:
    inputs:
      max_commits:
        description: 'Number of commits to rewrite (default: all)'
        required: false
        default: ''
      provider:
        description: 'AI Provider'
        required: true
        default: 'deepseek'
        type: choice
        options:
          - deepseek
          - ollama
      model:
        description: 'AI Model (optional)'
        required: false
      language:
        description: 'Language (en, zh, etc.)'
        required: false
        default: 'zh'
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '.github/workflows/**'
      - 'README.md'

permissions:
  contents: write

jobs:
  rewrite:
    name: Rewrite Commit History
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, '[skip-rewrite]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install git-rewrite-commits
        run: |
          pip install .

      - name: Configure Git Identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Rewrite Commits
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          # Define base arguments
          ARGS="--skip-remote-consent --quiet"
          
          # Add inputs if they exist (workflow_dispatch)
          if [ "${{ inputs.max_commits }}" != "" ]; then
            ARGS="$ARGS --max-commits ${{ inputs.max_commits }}"
          fi
          
          if [ "${{ inputs.model }}" != "" ]; then
            ARGS="$ARGS --model ${{ inputs.model }}"
          fi
          
          LANGUAGE="${{ inputs.language }}"
          if [ -z "$LANGUAGE" ]; then LANGUAGE="en"; fi
          ARGS="$ARGS --language $LANGUAGE"
          
          PROVIDER="${{ inputs.provider }}"
          if [ -z "$PROVIDER" ]; then PROVIDER="deepseek"; fi

          # For push events, limit scope to prevent deep history rewrites on every push
          # But user wants "every new submission... rewrite record"
          if [ "${{ github.event_name }}" == "push" ]; then
             # Just rewrite the last 10 commits to cover the pushed batch and ensure consistency
             # If commits are already well-formed, they will be skipped
             ARGS="$ARGS --max-commits 10"
          fi
          
          echo "Running: git-rewrite-commits --provider $PROVIDER $ARGS"
          
          # Run the rewriter
          git-rewrite-commits --provider $PROVIDER $ARGS
          
          # Push changes if any
          LOCAL_HASH=$(git rev-parse HEAD)
          REMOTE_HASH=$(git rev-parse origin/${{ github.ref_name }})
          
          if [ "$LOCAL_HASH" != "$REMOTE_HASH" ]; then
            echo "Changes detected. Force pushing..."
            git push origin HEAD:${{ github.ref }} --force
          else
            echo "No changes needed."
          fi
